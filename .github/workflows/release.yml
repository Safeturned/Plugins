name: Release

on:
  create:
    tags:
      - "*"
  push:
    branches: [master]
    paths:
      - '.github/workflows/release.yml'
      - 'Safeturned.Loader/**'
      - 'Safeturned.Module/**'
      - 'Safeturned.PluginInstaller/**'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: 8.0.x

      - name: Build Safeturned.Loader
        uses: ./.github/actions/project-build
        id: loader-build
        with:
          project_path: Safeturned.Loader
          project_name: Safeturned.Loader

      - name: Build Safeturned.Module
        uses: ./.github/actions/project-build
        id: module-build
        with:
          project_path: Safeturned.Module
          project_name: Safeturned.Module

      - name: Build Safeturned.PluginInstaller
        uses: ./.github/actions/project-build
        id: installer-build
        with:
          project_path: Safeturned.PluginInstaller
          project_name: Safeturned.PluginInstaller

      - name: Repack PluginInstaller zip
        run: |
          cd Safeturned.PluginInstaller/bin/Release/net48
          rm -f Safeturned.PluginInstaller.zip
          mkdir -p tmp
          cp Safeturned.PluginInstaller/Safeturned.PluginInstaller.dll tmp/
          cp Safeturned.PluginInstaller/Safeturned.PluginInstaller.pdb tmp/ 2>/dev/null || true
          cd tmp
          zip -qq Safeturned.PluginInstaller.zip *
          mv Safeturned.PluginInstaller.zip ../
          cd ..
          rm -rf tmp

      - name: Prepare artifacts
        run: |
          mkdir -p artifacts/Safeturned.Loader
          mkdir -p artifacts/Safeturned.Module
          mkdir -p artifacts/Safeturned.PluginInstaller

          cp -r Safeturned.Loader/bin/Release/net48/Safeturned.Loader/* artifacts/Safeturned.Loader/
          cp -r Safeturned.Module/bin/Release/net48/Safeturned.Module/* artifacts/Safeturned.Module/

          # PluginInstaller only needs the main dll and pdb
          cp Safeturned.PluginInstaller/bin/Release/net48/Safeturned.PluginInstaller/Safeturned.PluginInstaller.dll artifacts/Safeturned.PluginInstaller/
          cp Safeturned.PluginInstaller/bin/Release/net48/Safeturned.PluginInstaller/Safeturned.PluginInstaller.pdb artifacts/Safeturned.PluginInstaller/ 2>/dev/null || true

      - name: Upload Safeturned.Loader
        uses: actions/upload-artifact@v5
        with:
          name: Safeturned.Loader
          path: artifacts/Safeturned.Loader/
          if-no-files-found: error

      - name: Upload Safeturned.Module
        uses: actions/upload-artifact@v5
        with:
          name: Safeturned.Module
          path: artifacts/Safeturned.Module/
          if-no-files-found: error

      - name: Upload Safeturned.PluginInstaller
        uses: actions/upload-artifact@v5
        with:
          name: Safeturned.PluginInstaller
          path: artifacts/Safeturned.PluginInstaller/
          if-no-files-found: error

      - name: Create Release
        if: github.event_name == 'create' && github.event.ref_type == 'tag'
        uses: ncipollo/release-action@v1
        with:
          name: Release v${{ steps.loader-build.outputs.version }}
          tag: ${{ steps.loader-build.outputs.version }}
          artifacts: |
            Safeturned.Loader/bin/Release/net48/Safeturned.Loader.zip
            Safeturned.Module/bin/Release/net48/Safeturned.Module.zip
            Safeturned.PluginInstaller/bin/Release/net48/Safeturned.PluginInstaller.zip
          token: ${{ secrets.PAT || secrets.GITHUB_TOKEN }}
          prerelease: ${{ steps.loader-build.outputs.is_prerelease }}
          allowUpdates: true
          draft: true
